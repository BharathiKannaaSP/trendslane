name: Trendslane Deploy

on:
  push:
    branches:
      - master #Fix the branch

jobs:
  # üßπ 1Ô∏è‚É£ Lint Stage
  lint:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.changes.outputs.changed }}
    steps:
      - name: üõéÔ∏è Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: üß© Setup PNPM
        run: |
          corepack enable
          corepack prepare pnpm@latest --activate

      # Turbo Cache Setup
      - name: Cache Turbo
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: üì¶ Install Dependencies
        run: pnpm install --frozen-lockfile --prefer-offline

      - name: üîç Detect changed apps
        id: changes
        run: |
          echo "Checking for changed apps..."
          git fetch --unshallow || true
          git fetch origin master

          if [ $(git rev-list --count HEAD) -eq 1 ]; then
            CHANGED=$(ls apps | xargs)
          else
            CHANGED=$(git diff --name-only HEAD~1 HEAD | grep '^apps/' | cut -d'/' -f2 | sort -u | xargs)
          fi

          if [ -z "$CHANGED" ]; then
            CHANGED="none"
          fi

          echo "Changed apps: $CHANGED"
          echo "changed=$CHANGED" >> $GITHUB_OUTPUT

      - name: üßπ Run Lint on Changed Apps
        if: steps.changes.outputs.changed != 'none'
        run: |
          for app in ${{ steps.changes.outputs.changed }}; do
            echo "üßπ Linting $app..."
            pnpm turbo run lint --filter=$app
          done

  # üèóÔ∏è 3Ô∏è‚É£ Build Stage
  build:
    runs-on: ubuntu-latest
    needs: lint
    outputs:
      changed: ${{ needs.lint.outputs.changed }}
    env: # üß© Clerk environment variables (for build time)
      NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
      CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}
      NEXT_PUBLIC_PRODUCT_SERVICE_URL: ${{ secrets.NEXT_PUBLIC_PRODUCT_SERVICE_URL }}
      DATABASE_URL: ${{ secrets.PRODUCT_SERVICE_DB }}
      DIRECT_URL: ${{ secrets.PRODUCT_SERVICE_DIRECT_URL }}

    steps:
      - name: üõéÔ∏è Checkout repository
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: üß© Setup PNPM
        run: |
          corepack enable
          corepack prepare pnpm@latest --activate

        # Turbo Cache Setup
      - name: Cache Turbo
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: üì¶ Install Dependencies
        run: pnpm install --frozen-lockfile --prefer-offline

      - name: üß¨ Generate Prisma Client
        run: pnpm --filter=product-db run db:generate

      - name: üèóÔ∏è Build Changed Apps
        if: needs.lint.outputs.changed != 'none'
        run: |
          for app in ${{ needs.lint.outputs.changed }}; do
            echo "üèóÔ∏è Building $app..."
            pnpm turbo run build --filter=$app
          done

  # üöÄ 4Ô∏è‚É£ Deploy Stage
  deploy:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read
      deployments: write
    env:
      # PROJECT_DEPLOYMENT_URL
      #VERCEL
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}

      #VERCEL PROJECT_ID
      VERCEL_PROJECT_ID_ADMIN: ${{ secrets.VERCEL_PROJECT_ID_ADMIN }}
      VERCEL_PROJECT_ID_CLIENT: ${{ secrets.VERCEL_PROJECT_ID_CLIENT }}
      VERCEL_PROJECT_ID_PRODUCT_SERVICE: ${{ secrets.VERCEL_PROJECT_ID_PRODUCT_SERVICE}}

      #VERCEL CLERK
      NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
      CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}

      #PRODUCT_SERVICE_URL
      NEXT_PUBLIC_PRODUCT_SERVICE_URL: ${{ secrets.NEXT_PUBLIC_PRODUCT_SERVICE_URL }}
      DATABASE_URL: ${{ secrets.PRODUCT_SERVICE_DB }}
      DIRECT_URL: ${{ secrets.PRODUCT_SERVICE_DIRECT_URL }}

    steps:
      - name: üõéÔ∏è Checkout repository
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: üß© Setup PNPM
        run: |
          corepack enable
          corepack prepare pnpm@latest --activate

        # Turbo Cache Setup
      - name: Cache Turbo
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: üì¶ Install Dependencies
        run: pnpm install --frozen-lockfile --prefer-offline

      - name: üß¨ Generate Prisma Client
        run: pnpm --filter=product-db run db:generate

      - name: üöÄ Deploy Changed Apps to Vercel
        if: needs.build.outputs.changed != 'none'
        env:
          # PROJECT_DEPLOYMENT_URL
          #VERCEL
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}

          #VERCEL PROJECT_ID
          VERCEL_PROJECT_ID_ADMIN: ${{ secrets.VERCEL_PROJECT_ID_ADMIN }}
          VERCEL_PROJECT_ID_CLIENT: ${{ secrets.VERCEL_PROJECT_ID_CLIENT }}
          VERCEL_PROJECT_ID_PRODUCT_SERVICE: ${{ secrets.VERCEL_PROJECT_ID_PRODUCT_SERVICE}}

          #VERCEL CLERK
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
          CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}

          #PRODUCT_SERVICE_URL
          NEXT_PUBLIC_PRODUCT_SERVICE_URL: ${{ secrets.NEXT_PUBLIC_PRODUCT_SERVICE_URL }}
          DATABASE_URL: ${{ secrets.PRODUCT_SERVICE_DB }}
          DIRECT_URL: ${{ secrets.PRODUCT_SERVICE_DIRECT_URL }}

        run: |
          for app in ${{ needs.build.outputs.changed }}; do
            echo "üöÄ Deploying $app..."
            
            if [ "$app" = "admin" ]; then
              echo "Deploying Admin app..."
              VERCEL_ORG_ID=$VERCEL_ORG_ID \
              VERCEL_PROJECT_ID=$VERCEL_PROJECT_ID_ADMIN \
              npx vercel deploy --yes --prod --token=$VERCEL_TOKEN
            fi

            if [ "$app" = "web" ]; then
              echo "Deploying Client app..."
              VERCEL_ORG_ID=$VERCEL_ORG_ID \
              VERCEL_PROJECT_ID=$VERCEL_PROJECT_ID_CLIENT \
              npx vercel deploy --yes --prod --token=$VERCEL_TOKEN
            fi

            if [ "$app" = "product-service" ]; then
              echo "Deploying Product Service app..."
              VERCEL_ORG_ID=$VERCEL_ORG_ID \
              VERCEL_PROJECT_ID=$VERCEL_PROJECT_ID_PRODUCT_SERVICE \
              npx vercel deploy --yes --prod --token=$VERCEL_TOKEN
            fi


          done
